let arr_dungeons = [
  {Name: "Sastasha", MaxID: 663},
  {Name: "The Tam-Tara Deepcroft", MaxID: 669},
  {Name: "Copperbell Mines", MaxID: 666},
  {Name: "Halatali", MaxID: 667},
  {Name: "The Thousand Maws of Toto-Rak", MaxID: 673},
  {Name: "Haukke Manor", MaxID: 670},
  {Name: "Brayflox's Longstop", MaxID: 674},
  {Name: "The Sunken Temple of Qarn", MaxID: 668},
  {Name: "Cutter's Cry", MaxID: 674},
  {Name: "The Stone Vigil", MaxID: 672},
  {Name: "Dzemael Darkhold", MaxID: 675},
  {Name: "The Aurum Vale", MaxID: 676},
  {Name: "The Wanderer's Palace", MaxID: 665},
  {Name: "Castrum Meridianum", MaxID: 678},
  {Name: "The Praetorium", MaxID: 679},
  {Name: "Amdapor Keep", MaxID: 671},
  {Name: "Pharos Sirius", MaxID: 873},
  {Name: "Copperbell Mines (Hard)", MaxID: 871},
  {Name: "Haukke Manor (Hard)", MaxID: 872},
  {Name: "The Lost City of Amdapor", MaxID: 897},
  {Name: "Halatali (Hard)", MaxID: 895},
  {Name: "Brayflox's Longstop (Hard)", MaxID: 896},
  {Name: "Hullbreaker Isle", MaxID: 993},
  {Name: "The Stone Vigil (Hard)", MaxID: 992},
  {Name: "The Tam-Tara Deepcroft (Hard)", MaxID: 991},
  {Name: "Snowcloak", MaxID: 1039},
  {Name: "Sastasha (Hard)", MaxID: 1038},
  {Name: "The Sunken Temple of Qarn (Hard)", MaxID: 1037},
  {Name: "The Keeper of the Lake", MaxID: 1072},
  {Name: "The Wanderer's Palace (Hard)", MaxID: 1071},
  {Name: "Amdapor Keep (Hard)", MaxID: 1070}
]

let hw_dungeons = [
  {Name: "The Dusk Vigil", ID: 1208},
  {Name: "Sohm Al", ID: 1209},
  {Name: "The Aery", ID: 1210},
  {Name: "The Vault", ID: 1211},
  {Name: "The Great Gubal Library", ID: 1212},
  {Name: "The Aetherochemical Research Facility", ID: 1213},
  {Name: "Neverreap", ID: 1214},
  {Name: "The Fractal Continuum", ID: 1215},
  {Name: "Saint Mocianne's Arboretum", ID: 1402},
  {Name: "Pharos Sirius (Hard)", ID: 1403},
  {Name: "The Antitower", ID: 1486},
  {Name: "The Lost City of Amdapor (Hard)", ID: 1487},
  {Name: "Sohr Khai", ID: 1599},
  {Name: "Hullbreaker Isle (Hard)", ID: 1600},
  {Name: "Xelphatol", ID: 1637},
  {Name: "The Great Gubal Library (Hard)", ID: 1638},
  {Name: "Baelsar's Wall", ID: 1686},
  {Name: "Sohm Al (Hard)", ID: 1687}
]

let sb_dungeons = [
  {Name: "The Sirensong Sea", ID: 1883},
  {Name: "Shisui of the Violet Tides", ID: 1884},
  {Name: "Bardam's Mettle", ID: 1885},
  {Name: "Doma Castle", ID: 1886},
  {Name: "Castrum Abania", ID: 1887},
  {Name: "Ala Mhigo", ID: 1888},
  {Name: "Kugane Castle", ID: 1889},
  {Name: "The Temple of the Fist", ID: 1890},
  {Name: "The Drowned City of Skalla", ID: 1988},
  {Name: "Hells' Lid", ID: 2021},
  {Name: "The Fractal Continuum (Hard)", ID: 2022},
  {Name: "The Swallow's Compass", ID: 2057},
  {Name: "The Burn", ID: 2115},
  {Name: "Saint Mocianne's Arboretum (Hard)", ID: 2116},
  {Name: "The Ghimlyt Dark", ID: 2162}
]

let shb_dungeons = [
  {Name: "Holminster Switch", ID: 2377},
  {Name: "Dohn Mheg", ID: 2378},
  {Name: "The Qitana Ravel", ID: 2379},
  {Name: "Malikah's Well", ID: 2380},
  {Name: "Mt. Gulg", ID: 2381},
  {Name: "Amaurot", ID: 2382},
  {Name: "The Twinning", ID: 2383},
  {Name: "Akadaemia Anyder", ID: 2384},
  {Name: "The Grand Cosmos", ID: 2440},
  {Name: "Anamnesis Anyder", ID: 2589},
  {Name: "The Heroes' Gauntlet", ID: 2618},
  {Name: "Matoya's Relict", ID: 2717},
  {Name: "Paglth'an", ID: 2849}
]

let arr_trials = [
  {Name: "The Bowl of Embers"},
  {Name: "The Navel"},
  {Name: "The Howling Eye"},
  {Name: "Cape Westwind"},
  {Name: "The Chrysalis", ID: 1067},
  {Name: "The Steps of Faith", ID: 1065},
  {Name: "A Relic Reborn: The Chimera"},
  {Name: "A Relic Reborn: The Hydra"},
  {Name: "Battle on the Big Bridge"},
  {Name: "The Dragon's Neck"},
  {Name: "Battle in the Big Keep", ID: 1066},
  {Name: "The Bowl of Embers (Hard)"},
  {Name: "The Howling Eye (Hard)"},
  {Name: "The Navel (Hard)"},
  {Name: "Thornmarch (Hard)"},
  {Name: "The Whorleater (Hard)"},
  {Name: "The Striking Tree (Hard)"},
  {Name: "Akh Afah Amphitheatre (Hard) 	"},
  {Name: "Urth's Fount", ID: 1064}
]

let hw_trials = [
  {Name: "Thok ast Thok (Hard)"},
  {Name: "The Limitless Blue (Hard)"},
  {Name: "The Singularity Reactor"},
  {Name: "The Final Steps of Faith"},
  {Name: "Containment Bay S1T7"},
  {Name: "Containment Bay P1T6"},
  {Name: "Containment Bay Z1T9"}
]

let sb_trials = [
  {Name: "The Pool of Tribute"},
  {Name: "Emanation"},
  {Name: "The Royal Menagerie"},
  {Name: "Castrum Fluminis"},
  {Name: "Kugane Ohashi", ID: 2236},
  {Name: "The Great Hunt"},
  {Name: "The Jade Stoa"},
  {Name: "Hells' Kier"},
  {Name: "The Wreath of Snakes"}
]

let shb_trials = [
  {Name: "The Dancing Plague"},
  {Name: "The Crown of the Immaculate"},
  {Name: "The Dying Gasp"},
  {Name: "Cinder Drift"},
  {Name: "The Seat of Sacrifice"},
  {Name: "Castrum Marinum"},
  {Name: "The Cloud Deck"}
]

let arr_trials_ex = [
  {Name: "The Minstrel's Ballad: Ultima's Bane"},
  {Name: "The Howling Eye (Extreme)", ID: 856},
  {Name: "The Navel (Extreme)", ID: 857},
  {Name: "The Bowl of Embers (Extreme)", ID: 855},
  {Name: "Thornmarch (Extreme)", ID: 894},
  {Name: "The Whorleater (Extreme)", ID: 893},
  {Name: "The Striking Tree (Extreme)", ID: 994},
  {Name: "Akh Afah Amphitheatre (Extreme)", ID: 1045}
]

let hw_trials_ex = [
  {Name: "The Limitless Blue (Extreme)", ID: 1220},
  {Name: "Thok ast Thok (Extreme)", ID: 1221},
  {Name: "The Minstrel's Ballad: Thordan's Reign 	", ID: 1400},
  {Name: "The Minstrel's Ballad: Nidhogg's Rage", ID: 1601},
  {Name: "Containment Bay S1T7 (Extreme)", ID: 1485},
  {Name: "Containment Bay P1T6 (Extreme)", ID: 1636},
  {Name: "Containment Bay Z1T9 (Extreme)", ID: 1685}
]

let sb_trials_ex = [
  {Name: "The Pool of Tribute (Extreme)", ID: 1902},
  {Name: "Emanation (Extreme)", ID: 1901},
  {Name: "The Minstrel's Ballad: Shinryu's Domain", ID: 1989},
  {Name: "The Minstrel's Ballad: Tsukuyomi's Pain", ID: 2060},
  {Name: "The Great Hunt (Extreme)", ID: 2109},
  {Name: "The Jade Stoa (Extreme)", ID: 2023},
  {Name: "Hells' Kier (Extreme)", ID: 2117},
  {Name: "The Wreath of Snakes (Extreme)", ID: 2165}
]

let shb_trials_ex = [
  {Name: "The Dancing Plague (Extreme)", ID: 2385},
  {Name: "The Crown of the Immaculate (Extreme)", ID: 2386},
  {Name: "Minstrel's Ballad: Hades's Elegy", ID: 2441},
  {Name: "Cinder Drift (Extreme)", ID: 2590},
  {Name: "Memoria Misera (Extreme)", ID: 2586},
  {Name: "The Seat of Sacrifice (Extreme)", ID:2621},
  {Name: "Castrum Marinum (Extreme)", ID: 2718},
  {Name: "The Cloud Deck (Extreme)", ID: 2846}
]

let arr_raids = [
  {Name: "Labyrinth of the Ancients", ID: 883},
  {Name: "Syrcus Tower", ID: 995},
  {Name: "The World of Darkness", ID: 1068},
  {Name: "The Binding Coil of Bahamut", ID: 747},
  {Name: "The Second Coil of Bahamut", ID: 887},
  {Name: "The Final Coil of Bahamut", ID: 1040}
]

let hw_raids = [
  {Name: "The Void Ark", ID: 1399},
  {Name: "The Weeping City of Mhach", ID: 1574},
  {Name: "Dun Scaith", ID: 1689},
  {Name: "Alexander: Gordias", ID: 1228},
  {Name: "Alexander: Midas", ID: 1476},
  {Name: "Alexander: The Creator", ID: 1639}
]

let sb_raids = [
  {Name: "The Royal City of Rabanastre 	", ID: 1992},
  {Name: "The Ridorana Lighthouse", ID: 2106},
  {Name: "The Orbonne Monastery", ID: 2164},
  {Name: "Omega: Deltascape", ID: 1895},
  {Name: "Omega: Sigmascape", ID: 2024},
  {Name: "Omega: Alphascape", ID: 2118}
]

let shb_raids = [
  {Name: "The Copied Factory", ID: 2443},
  {Name: "The Puppets' Bunker", ID: 2622},
  {Name: "The Tower at Paradigm's Breach", ID: 2847},
  {Name: "Eden's Gate", ID: 2409},
  {Name: "Eden's Verse", ID: 2591},
  {Name: "Eden's Promise", ID: 2719}
]

let arr_raids_s = [
  {Name: "The Second Coil of Bahamut (Savage)", ID: 1000}
]

let hw_raids_s = [
  {Name: "Alexander: Gordias (Savage)", ID: 1231},
  {Name: "Alexander: Midas (Savage)", ID: 1479},
  {Name: "Alexander: The Creator (Savage)", ID: 1642}
]

let sb_raids_s = [
  {Name: "Omega: Deltascape (Savage)", ID: 1898},
  {Name: "Omega: Sigmascape (Savage)", ID: 2027},
  {Name: "Omega: Alphascape (Savage)", ID: 2121},
  {Name: "The Unending Coil of Bahamut (Ultimate)", ID: 1993},
  {Name: "The Minstrel's Ballad: The Weapon's Refrain (Ultimate)", ID: 2107}
]

let shb_raids_s = [
  {Name: "Eden's Gate (Savage)", ID: 2412},
  {Name: "Eden's Verse (Savage)", ID: 2594},
  {Name: "Eden's Promise (Savage)", ID: 2722},
  {Name: "The Epic of Alexander (Ultimate)", ID: 2444}
]

function renderError(message) {
  $("#error-block").show()
  $("#error-msg").html(message)
}

function renderList(id, list) {
  let html = ""
  for (let i = 0; i < list.length; i++) {
    let cleared = 0 // Not cleared
    if ("ID" in list[i] && achievements.has(list[i]["ID"])) cleared = 1 // Cleared
    else if ("MaxID" in list[i] && achievements.has(list[i]["MaxID"])) cleared = 1 // Cleared
    else if ("MinID" in list[i] && achievements.has(list[i]["MinID"])) cleared = -1 // Maybe
    else if (!("ID" in list[i])) cleared = -1 // Maybe

    html += "<li class='list-group-item d-flex justify-content-between align-items-center'"
    if (cleared == -1) {
      html += "><span class='bi-question-square'>"
    } else if (cleared == 1) {
      html += " style='color: green;'><span class='bi-check-square'>"
    } else {
      html += " style='color: firebrick;'><span class='bi-square'>"
    }
    html += "&nbsp;&nbsp;" + list[i]["Name"] + "</span>"
    // @TODO: Display date (on hover?)
    // if (achievements.has(list[i]["ID"])) {
    //   html += moment.unix(achievements.get(list[i]["ID"])).format('dddd, MMMM Do, YYYY h:mm:ss A')
    // }
    html += "</li>"
  }
  $(id).html(html)
}

function renderEmpty() {
  let categories = ["arr_dungeons", "hw_dungeons", "sb_dungeons", "shb_dungeons",
                  "arr_trials", "hw_trials", "sb_trials", "shb_trials",
                  "arr_trials_ex", "hw_trials_ex", "sb_trials_ex", "shb_trials_ex",
                  "arr_raids", "hw_raids", "sb_raids", "shb_raids",
                  "arr_raids_s", "hw_raids_s", "sb_raids_s", "shb_raids_s"]

  for (let i = 0; i < categories.length; i++) {
    $("#" + categories[i]).html("<li>No data to display</li>")
  }
}

let searchParams = new URLSearchParams(window.location.search)
if (!searchParams.has("id")) {
  $("#c_name").html("&lt;Unknown Character&gt;")
  renderError("The URL must contain a character ID. For example, <a class='alert-link' href='?id=32741501'>/xivtodo/?id=32741501</a>")
  renderEmpty()
  throw new Error();
}
let characterID = searchParams.get("id")
let achievements

$.ajax({
	url: "https://xivapi.com/character/" + characterID + "?data=AC",
	dataType: "json",
  error: function(XMLHttpRequest, textStatus, errorThrown) { 
    $("#c_name").html("&lt;Unknown Character&gt;")
    renderError("The URL must contain a valid character ID. For example, <a class='alert-link' href='?id=32741501'>/xivtodo/?id=32741501</a>")
    renderEmpty()
  },
	success: function(data) {
    let character = data["Character"]
    achievements = new Map()
    for (let i = 0; i < data["Achievements"]["List"].length; i++) {
      achievements.set(data["Achievements"]["List"][i]["ID"], data["Achievements"]["List"][i]["Date"])
    }

		console.log(data)

    $("#c_name").html(character["Name"])

    if (!data["AchievementsPublic"]) {
      renderError("The achievements for this character are not public. If you are the owner of this character, you can set Achievements to Public in your <a class='alert-link' href='https://na.finalfantasyxiv.com/lodestone/my/setting/account/'>character settings</a>.")
      renderEmpty()
      return
    }

    renderList("#arr_dungeons", arr_dungeons)
    renderList("#hw_dungeons", hw_dungeons)
    renderList("#sb_dungeons", sb_dungeons)
    renderList("#shb_dungeons", shb_dungeons)

    renderList("#arr_trials", arr_trials)
    renderList("#hw_trials", hw_trials)
    renderList("#sb_trials", sb_trials)
    renderList("#shb_trials", shb_trials)

    renderList("#arr_trials_ex", arr_trials_ex)
    renderList("#hw_trials_ex", hw_trials_ex)
    renderList("#sb_trials_ex", sb_trials_ex)
    renderList("#shb_trials_ex", shb_trials_ex)

    renderList("#arr_raids", arr_raids)
    renderList("#hw_raids", hw_raids)
    renderList("#sb_raids", sb_raids)
    renderList("#shb_raids", shb_raids)

    renderList("#arr_raids_s", arr_raids_s)
    renderList("#hw_raids_s", hw_raids_s)
    renderList("#sb_raids_s", sb_raids_s)
    renderList("#shb_raids_s", shb_raids_s)

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
	}
});
